<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=IBM+Plex+Mono:wght@400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="authSection" class="card">
      <h1>Admin Auth</h1>
      <p class="subtitle">Silakan register atau login untuk melihat data.</p>

      <div class="input-group">
        <div>
          <label for="adminEmail">Email Admin</label>
          <input type="email" id="adminEmail" placeholder="admin@example.com" />
        </div>
        <div>
          <label for="adminPassword">Password Admin</label>
          <input type="password" id="adminPassword" placeholder="••••••••" />
        </div>
      </div>
      <div style="display: flex; gap: 1rem">
        <button id="registerBtn" class="btn btn-primary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.5 21c-2.305 0-4.47-.612-6.374-1.666z"
            />
          </svg>
          <span>Register</span>
        </button>
        <button id="loginBtn" class="btn btn-primary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"
            />
          </svg>
          <span>Login</span>
        </button>
      </div>
      <div id="authFeedback" class="alert"></div>
    </div>

    <div id="adminPanel" class="card" style="display: none">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h1>Admin Panel</h1>
        <button id="logoutBtn" class="btn btn-danger" style="width: auto">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l-3-3m0 0l3-3m-3 3H9"
            />
          </svg>
          <span>Logout</span>
        </button>
      </div>
      <p class="subtitle">
        Login sebagai: <strong id="loggedInEmail"></strong>
      </p>

      <hr class="separator" />

      <h2>List API Keys</h2>
      <button id="listBtn" class="btn btn-primary" style="margin-bottom: 1rem">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"
          />
        </svg>
        <span>Tampilkan List API Keys</span>
      </button>

      <div id="listFeedback" class="alert"></div>

      <div class="user-table-container">
        <table class="user-table">
          <thead>
            <tr>
              <th>Key ID</th>
              <th>Pemilik (Email)</th>
              <th>API Key</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="userListBody"></tbody>
        </table>
      </div>
    </div>

    <footer>© 2025 PWS RefkySyahrin</footer>

    <script>
      let jwtToken = null;

      // --- 1. Pemilih Elemen DOM ---
      const authSection = document.getElementById("authSection");
      const adminPanel = document.getElementById("adminPanel");

      const registerBtn = document.getElementById("registerBtn");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const listBtn = document.getElementById("listBtn");

      const adminEmailInput = document.getElementById("adminEmail");
      const adminPasswordInput = document.getElementById("adminPassword");
      const loggedInEmail = document.getElementById("loggedInEmail");

      const authFeedback = document.getElementById("authFeedback");
      const listFeedback = document.getElementById("listFeedback");
      const userListBody = document.getElementById("userListBody");

      // --- 2. Fungsi Tampilan (UI) ---

      /** BARU: Fungsi showFeedback yang disempurnakan */
      function showFeedback(element, message, isValid) {
        element.textContent = message;
        // Reset kelas, lalu tambahkan yang sesuai
        element.className = "alert";
        element.classList.add(isValid ? "alert-success" : "alert-error");
        element.style.display = "block"; // Tampilkan alert box

        setTimeout(() => {
          element.style.display = "none"; // Sembunyikan setelah 3 detik
        }, 3000);
      }

      /** Menampilkan panel admin setelah login sukses */
      function showAdminPanel(email, token) {
        jwtToken = token;
        loggedInEmail.textContent = email;
        authSection.style.display = "none";
        adminPanel.style.display = "block";
        listKeys(); // Otomatis muat daftar key
      }

      /** Menampilkan panel login (saat logout) */
      function showLoginPanel() {
        jwtToken = null;
        loggedInEmail.textContent = "";
        authSection.style.display = "block";
        adminPanel.style.display = "none";
        adminEmailInput.value = "";
        adminPasswordInput.value = "";
      }

      // --- 3. Fungsi Logika (Fetch API Admin) ---

      /** REGISTER ADMIN: Ditambah status Loading */
      async function registerAdmin() {
        const registerBtnSpan = registerBtn.querySelector("span");
        registerBtn.disabled = true;
        registerBtnSpan.textContent = "Registering...";

        try {
          const res = await fetch("/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: adminEmailInput.value,
              password: adminPasswordInput.value,
            }),
          });
          const data = await res.json();
          showFeedback(authFeedback, data.message || data.error, res.ok);
        } catch (err) {
          showFeedback(authFeedback, "Error jaringan.", false);
        } finally {
          registerBtn.disabled = false;
          registerBtnSpan.textContent = "Register";
        }
      }

      /** LOGIN ADMIN: Ditambah status Loading */
      async function loginAdmin() {
        const loginBtnSpan = loginBtn.querySelector("span");
        loginBtn.disabled = true;
        loginBtnSpan.textContent = "Logging In...";

        try {
          const res = await fetch("/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: adminEmailInput.value,
              password: adminPasswordInput.value,
            }),
          });
          const data = await res.json();
          if (res.ok) {
            showAdminPanel(adminEmailInput.value, data.token);
          } else {
            showFeedback(authFeedback, data.error, false);
          }
        } catch (err) {
          showFeedback(authFeedback, "Error jaringan.", false);
        } finally {
          loginBtn.disabled = false;
          loginBtnSpan.textContent = "Login";
        }
      }

      /** LIST KEYS: Ditambah status Loading */
      async function listKeys() {
        const listBtnSpan = listBtn.querySelector("span");
        listBtn.disabled = true;
        listBtnSpan.textContent = "Memuat...";

        try {
          const res = await fetch("/apikeys", {
            headers: { Authorization: `Bearer ${jwtToken}` },
          });
          const keys = await res.json();

          if (!res.ok) {
            showFeedback(listFeedback, keys.error, false);
            if (res.status === 401 || res.status === 403) {
              showLoginPanel();
            }
            return;
          }

          userListBody.innerHTML = "";
          if (keys.length === 0) {
            userListBody.innerHTML =
              '<tr><td colspan="4">Belum ada API Key.</td></tr>';
          }

          keys.forEach((key) => {
            userListBody.innerHTML += `
                        <tr>
                            <td>${key.id}</td>
                            <td>${key.owner_email}</td>
                            <td>${key.key_value}</td>
                            <td>${key.status}</td>
                        </tr>
                    `;
          });
        } catch (err) {
          showFeedback(listFeedback, "Error jaringan.", false);
        } finally {
          listBtn.disabled = false;
          listBtnSpan.textContent = "Tampilkan List API Keys";
        }
      }

      // --- 4. Event Listeners ---
      registerBtn.addEventListener("click", registerAdmin);
      loginBtn.addEventListener("click", loginAdmin);
      logoutBtn.addEventListener("click", showLoginPanel);
      listBtn.addEventListener("click", listKeys);
    </script>
  </body>
</html>
